# Применение изменений ролей администратора

Этот проект переключает авторизацию администраторов с булевого флага `is_admin` на строковое поле `role`. Ниже приведён сценарий, который можно использовать при выкладке изменений на сервер или на локальную машину разработчика.

## 1. Подготовка

1. Сделайте резервную копию базы данных (например, с помощью `mysqldump` или инструмента СУБД).
2. Убедитесь, что у вас есть свежий код из ветки с изменениями. Если изменения ещё не влиты в `main`, выполните шаги из файла
   [`docs/how-to-checkout-pr-branch.md`](how-to-checkout-pr-branch.md), чтобы получить рабочую ветку с предложенными правками.
3. Установите зависимости PHP, если этого ещё не сделано:
   ```bash
   composer install --no-dev --optimize-autoloader
   ```

## 2. Прогон миграций

1. Проверьте, какие миграции будут выполнены:
   ```bash
   php artisan migrate:status
   ```
2. Запустите миграции. Все три патча (добавление `is_admin`, добавление `role` и синхронизация значений) выполнятся автоматически, потому что они уже находятся в каталоге `database/migrations`:
   ```bash
   php artisan migrate
   ```

При выполнении миграции `2025_03_10_000000_sync_admin_role_flag` все пользователи со старым признаком `is_admin = true` получат `role = 'admin'`, а колонка `is_admin` будет удалена.

## 3. Проверка результатов

1. Убедитесь, что столбца `is_admin` больше нет, а роли администраторов установлены:
   ```sql
   SELECT id, email, role FROM users WHERE role = 'admin';
   ```
2. При необходимости очистите кэш аутентификации:
   ```bash
   php artisan cache:clear
   php artisan config:clear
   ```

## 4. Откат (при необходимости)

Если потребуется вернуться к старой схеме, выполните:
```bash
php artisan migrate:rollback --step=1
```
Эта команда вызовет откат миграции синхронизации: колонка `is_admin` будет воссоздана, и все пользователи с `role = 'admin'` получат `is_admin = true`.

---

Следуя этим шагам, вы примените обновления, не потеряв существующие права администраторов.
